<!DOCTYPE html>
<html>
  <head>
    <title>AR.js animado y optimizado</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.min.js"></script>
    <style>
      body { margin: 0; overflow: hidden; }
      #info { position: absolute; top: 10px; left: 10px; color: white; font-family: sans-serif; }
    </style>

<script>
  // Cubo: rotación continua
  /*
  AFRAME.registerComponent('cube-anim', {
    tick: function (time, timeDelta) {
      const rot = this.el.getAttribute('rotation');
      this.el.setAttribute('rotation', {
        x: rot.x,
        y: rot.y + (timeDelta * 0.05),
        z: rot.z
      });
    }
  });
  */

  // Cilindro: cambio de color
  /*
  AFRAME.registerComponent('cilindro-color', {
    tick: function (time) {
      const t = Math.abs(Math.sin(time / 1000)); // 0 a 1
      const r = Math.floor(255 * t);
      const g = Math.floor(255 * (1 - t));
      this.el.setAttribute('color', `rgb(${r},${g},0)`);
    }
  });
  */

  // Esfera: desaparece al hacer clic
  document.addEventListener('touchstart', function (evt) {
      // Crear raycaster
    const raycaster = new THREE.Raycaster();
    const mouse = new THREE.Vector2();
    const sceneEl = document.querySelector('a-scene');

    // Obtener posición normalizada de pantalla
    const touch = event.touches[0];
    const rect = sceneEl.canvas.getBoundingClientRect();
    mouse.x = ((touch.clientX - rect.left) / rect.width) * 2 - 1;
    mouse.y = -((touch.clientY - rect.top) / rect.height) * 2 + 1;

    // Definir raycaster desde cámara
    const camera = sceneEl.camera;
    raycaster.setFromCamera(mouse, camera);

    // Obtener todos los objetos de A-Frame (solo visibles)
    const objects = [];
    sceneEl.object3D.traverse(function (obj) {
      if (obj.el) {
        objects.push(obj);
      }
    });

    // Comprobar intersecciones
    const intersects = raycaster.intersectObjects(objects, true);
    if (intersects.length > 0) {
      // Subir en la jerarquía hasta encontrar el objeto con .el
      let intersected = intersects[0].object;
      while (intersected && !intersected.el) {
        intersected = intersected.parent;
      }

      if (intersected && intersected.el) {
        // Cambiar color
        intersected.el.setAttribute('color', '#'+Math.floor(Math.random()*16777215).toString(16));

        // Reproducir sonido
        //const sound = document.querySelector('#sonido');
        //sound.components.sound.playSound();

      }
    }
  });


</script>

</head>
<body>
  <div id="info">Prueba código Sonido 2</div>

  <a-scene embedded arjs>
    <a-marker preset="hiro">
      
      <!-- Cubo   -->
      <a-box id="cubo" position="0 0.5 0" color="blue" 
            cube-anim></a-box>

      <a-entity id="sonido" sound="src: #audio-click; autoplay: false"></a-entity>

      <!-- Esfera verde clicable
      <a-sphere id="bola" position="0 0.5 0" radius="0.3" color="green" 
                bola-interact class="clickable"></a-sphere>
 -->
      <!-- Cilindro 
      <a-cylinder id="cilindro" position="-1 0.75 0" radius="0.2" height="1.5"
                  color="yellow"  cilindro-color></a-cylinder>
  -->
    </a-marker>

    <a-entity camera></a-entity>

    <!-- Definición del sonido -->
    <audio id="audio-click" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_f64a6be88e.mp3?filename=click-124467.mp3"></audio>


  </a-scene>

  </body>
</html>
